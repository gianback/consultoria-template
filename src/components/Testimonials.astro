---
const testimonios = [
  {
    id: 1,
    nombre: "María García López",
    puesto: "CEO",
    empresa: "TechStart Solutions",
    foto: "https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=150&h=150&fit=crop&crop=face",
    testimonio: "La consultoría estratégica que recibimos transformó completamente nuestra visión de negocio. Incrementamos nuestros ingresos en un 40% en solo seis meses.",
    calificacion: 5
  },
  {
    id: 2,
    nombre: "Carlos Rodríguez Pérez",
    puesto: "Director de Operaciones",
    empresa: "Logística Global S.A.",
    foto: "https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=150&h=150&fit=crop&crop=face",
    testimonio: "El equipo de ConsultoríaPro nos ayudó a optimizar nuestros procesos logísticos. Redujimos costos operativos en un 30% manteniendo la calidad del servicio.",
    calificacion: 5
  },
  {
    id: 3,
    nombre: "Ana Martínez Sánchez",
    puesto: "Directora Financiera",
    empresa: "Inversiones Estratégicas",
    foto: "https://images.unsplash.com/photo-1580489944761-15a19d654956?w=150&h=150&fit=crop&crop=face",
    testimonio: "Su análisis de datos nos proporcionó insights que nunca habríamos descubierto solos. Ahora tomamos decisiones basadas en información precisa y oportuna.",
    calificacion: 5
  },
  {
    id: 4,
    nombre: "Roberto Fernández Torres",
    puesto: "Fundador",
    empresa: "InnovaTech Labs",
    foto: "https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=150&h=150&fit=crop&crop=face",
    testimonio: "La transformación digital que implementaron fue clave para nuestra expansión internacional. Profesionalismo y resultados garantizados.",
    calificacion: 5
  },
  {
    id: 5,
    nombre: "Laura Jiménez Ruiz",
    puesto: "Gerente General",
    empresa: "Retail Excellence",
    foto: "https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=150&h=150&fit=crop&crop=face",
    testimonio: "Excelente experiencia de principio a fin. El equipo demostró un profundo conocimiento de nuestro sector y propuso soluciones innovadoras.",
    calificacion: 5
  },
  {
    id: 6,
    nombre: "Miguel Ángel Herrera",
    puesto: "Director de Tecnología",
    empresa: "Digital Ventures",
    foto: "https://images.unsplash.com/photo-1500648767791-00dcc994a43e?w=150&h=150&fit=crop&crop=face",
    testimonio: "La gestión del cambio que lideraron en nuestra empresa fue excepcional. El equipo adoptó las nuevas metodologías con entusiasmo y eficiencia.",
    calificacion: 5
  }
];

const renderStars = (rating: number) => {
  return Array(5).fill(null).map((_, index) => index < rating);
};
---

<section class="testimonials section bg-gray">
  <div class="container">
    <div class="section-header">
      <span class="section-tag">Testimonios</span>
      <h2 class="section-title">Clientes Satisfechos</h2>
      <p class="section-subtitle">
        Descubra cómo hemos ayudado a empresas como la suya a alcanzar sus objetivos
      </p>
    </div>

    <div class="testimonials-wrapper">
      <div class="testimonials-track">
        {testimonios.map((testimonio) => (
          <article class="testimonial-card">
            <div class="testimonial-rating">
              {renderStars(testimonio.calificacion).map((filled) => (
                <svg
                  class={`star ${filled ? 'filled' : ''}`}
                  width="18"
                  height="18"
                  viewBox="0 0 24 24"
                  fill={filled ? 'currentColor' : 'none'}
                  stroke="currentColor"
                  stroke-width="2"
                >
                  <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                </svg>
              ))}
            </div>
            <blockquote class="testimonial-quote">
              "{testimonio.testimonio}"
            </blockquote>
            <div class="testimonial-author">
              <img
                src={testimonio.foto}
                alt={testimonio.nombre}
                class="author-photo"
                loading="lazy"
              />
              <div class="author-info">
                <strong class="author-name">{testimonio.nombre}</strong>
                <span class="author-role">
                  {testimonio.puesto}, {testimonio.empresa}
                </span>
              </div>
            </div>
          </article>
        ))}
      </div>
    </div>

    <div class="testimonials-controls">
      <button class="control-btn prev" aria-label="Anterior">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
      </button>
      <div class="testimonials-dots"></div>
      <button class="control-btn next" aria-label="Siguiente">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 18l6-6-6-6"/>
        </svg>
      </button>
    </div>
  </div>
</section>

<style>
  .testimonials {
    overflow: hidden;
  }

  .section-tag {
    display: inline-block;
    padding: var(--spacing-2) var(--spacing-4);
    background-color: rgba(26, 54, 93, 0.1);
    color: var(--color-primary);
    font-size: var(--text-sm);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    border-radius: var(--radius-full);
    margin-bottom: var(--spacing-4);
  }

  .testimonials-wrapper {
    position: relative;
    overflow: hidden;
    margin: 0 calc(var(--spacing-6) * -1);
    padding: 0 var(--spacing-6);
  }

  .testimonials-track {
    display: flex;
    gap: var(--spacing-6);
    transition: transform 0.5s ease;
  }

  .testimonial-card {
    flex: 0 0 calc(33.333% - var(--spacing-4));
    background-color: var(--color-white);
    padding: var(--spacing-8);
    border-radius: var(--radius-xl);
    box-shadow: var(--shadow-md);
    transition: transform var(--transition-base), box-shadow var(--transition-base);
  }

  .testimonial-card:hover {
    transform: translateY(-5px);
    box-shadow: var(--shadow-xl);
  }

  .testimonial-rating {
    display: flex;
    gap: var(--spacing-1);
    margin-bottom: var(--spacing-4);
  }

  .star {
    color: var(--color-accent);
  }

  .testimonial-quote {
    font-size: var(--text-base);
    line-height: 1.8;
    color: var(--color-secondary-dark);
    margin: 0 0 var(--spacing-6);
    font-style: italic;
  }

  .testimonial-author {
    display: flex;
    align-items: center;
    gap: var(--spacing-4);
    padding-top: var(--spacing-5);
    border-top: 1px solid var(--color-gray-100);
  }

  .author-photo {
    width: 56px;
    height: 56px;
    border-radius: var(--radius-full);
    object-fit: cover;
    border: 3px solid var(--color-gray-100);
  }

  .author-info {
    display: flex;
    flex-direction: column;
  }

  .author-name {
    font-weight: 600;
    color: var(--color-primary-dark);
    font-size: var(--text-base);
  }

  .author-role {
    font-size: var(--text-sm);
    color: var(--color-secondary);
  }

  .testimonials-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--spacing-4);
    margin-top: var(--spacing-10);
  }

  .control-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 48px;
    height: 48px;
    background-color: var(--color-white);
    border: 2px solid var(--color-gray-200);
    border-radius: var(--radius-full);
    cursor: pointer;
    color: var(--color-primary);
    transition: all var(--transition-fast);
  }

  .control-btn:hover {
    background-color: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-white);
  }

  .testimonials-dots {
    display: flex;
    gap: var(--spacing-2);
  }

  .testimonials-dots :global(.dot) {
    width: 10px;
    height: 10px;
    border-radius: var(--radius-full);
    background-color: var(--color-gray-300);
    cursor: pointer;
    transition: background-color var(--transition-fast), width var(--transition-fast);
  }

  .testimonials-dots :global(.dot.active) {
    width: 30px;
    background-color: var(--color-primary);
  }

  @media (max-width: 1024px) {
    .testimonial-card {
      flex: 0 0 calc(50% - var(--spacing-3));
    }
  }

  @media (max-width: 768px) {
    .testimonial-card {
      flex: 0 0 100%;
    }

    .testimonial-card {
      padding: var(--spacing-6);
    }
  }
</style>

<script>
  const track = document.querySelector('.testimonials-track') as HTMLElement;
  const cards = document.querySelectorAll('.testimonial-card');
  const prevBtn = document.querySelector('.control-btn.prev');
  const nextBtn = document.querySelector('.control-btn.next');
  const dotsContainer = document.querySelector('.testimonials-dots');

  let currentIndex = 0;
  let cardsPerView = 3;

  function updateCardsPerView() {
    if (window.innerWidth <= 768) {
      cardsPerView = 1;
    } else if (window.innerWidth <= 1024) {
      cardsPerView = 2;
    } else {
      cardsPerView = 3;
    }
  }

  function getMaxIndex() {
    return Math.max(0, cards.length - cardsPerView);
  }

  function createDots() {
    if (!dotsContainer) return;
    dotsContainer.innerHTML = '';
    const totalDots = getMaxIndex() + 1;
    for (let i = 0; i < totalDots; i++) {
      const dot = document.createElement('button');
      dot.classList.add('dot');
      dot.setAttribute('aria-label', `Ir a testimonio ${i + 1}`);
      if (i === currentIndex) dot.classList.add('active');
      dot.addEventListener('click', () => goToSlide(i));
      dotsContainer.appendChild(dot);
    }
  }

  function updateDots() {
    const dots = document.querySelectorAll('.dot');
    dots.forEach((dot, index) => {
      dot.classList.toggle('active', index === currentIndex);
    });
  }

  function goToSlide(index: number) {
    currentIndex = Math.max(0, Math.min(index, getMaxIndex()));
    updateCarousel();
  }

  function updateCarousel() {
    if (!track) return;
    const card = cards[0] as HTMLElement;
    const cardWidth = card.offsetWidth;
    const gap = 24;
    const offset = currentIndex * (cardWidth + gap);
    track.style.transform = `translateX(-${offset}px)`;
    updateDots();
  }

  prevBtn?.addEventListener('click', () => {
    goToSlide(currentIndex - 1);
  });

  nextBtn?.addEventListener('click', () => {
    goToSlide(currentIndex + 1);
  });

  window.addEventListener('resize', () => {
    updateCardsPerView();
    createDots();
    goToSlide(Math.min(currentIndex, getMaxIndex()));
  });

  updateCardsPerView();
  createDots();
</script>
